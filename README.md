# Terraform Gitlab with Gitlab runner
In this repository you found a example for how deploy gitlab on aws with a runner
![Terraform](https://img.shields.io/badge/terraform-%235835CC.svg?style=flat&logo=terraform&logoColor=white)
![Shell Script](https://img.shields.io/badge/bash_script-%23121011.svg?style=flat&logo=gnu-bash&logoColor=white)

We will use of
- Terraform
- AWS cli
- Bash

## Variables
_variables you should use in your `terraform.tfvars`
__First you need to create it and paste the following variables with your custom value__

```bash
role_arn             = "arn:aws:iam::00000000000000:role/example-role"
project_key          = "aws-key"
gitlab_root_password = "your strong password"
```

## VPC and Security Group
For this project, the default vpc was used. Feel free to modify this according to your needs.
_All the vpc and security group config used are in the file vpc.tf_

| vpc  | Group | Type | CIDR | Ports | Description |
| -----| ----- | ---- | ---- | ----- | ----------- |
| default | default | egress | 0.0.0.0/0 | 0:0/-1 | all outgoing traffics |
| default | default | ingress | 0.0.0.0/0 | 80:80/tcp | web-server | 
| default | default | ingress | 0.0.0.0/0 | 443:443/tcp | secure-web-server | 
| default | default | ingress | 0.0.0.0/32 | 22:22/tcp | ssh connection |

## Outputs
| Name | Description |
| ---- | ----------- |
| instance_public_dns | public dns of gitlab instance |
| instance_public_ip | public ip address of gitlab instance |
| registration_token | token generated by the gitlab instance for the registration of a new runner |

# Docs 
For more information on the resources used, you can consult the file [docs.md](docs.md)

## Terraform execution
```
# to install plugins
terraform init

# to preview the result
terraform plan

# to create the resources in the provider
terraform apply
```

## Interesting bash script used in this project
**Getting registration token from gitlab instance**
_the token was extracted in the following way because gitlab does not have an endpoint in its api to be able to extract this token_
```bash
#!/bin/bash

registration_token=$(ssh -o "StrictHostKeyChecking no" -i bruno-demo.pem -t ubuntu@$1 "sudo gitlab-rails runner -e production \"puts Gitlab::CurrentSettings.current_application_settings.runners_registration_token\"")
registration_token_json="{\"registration_token\": \"${registration_token}\"}"
echo ${registration_token_json}
```
